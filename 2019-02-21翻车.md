## 错误

    egg-cluster-script 没有将系统的全局 PATH 变量添加到启动环境中，导致前端访问页面时拿不到页面的正常版本号，无法展示页面，ums的接口请求都没有发出去导致服务不可用

## 背景

    由于 egg-script 不支持项目的集群平滑过渡重启，在单机热部署或分部署部署过程中，需要将单机的服务先终止后，再启动服务，会造成一小段服务不可用的空档。

    egg-cluster-script（下面建成ecs） 在设计时借鉴了 egg-script 的启动方式，最后由一个子进程执行 egg.startCluster 的方式，在子进程中启动集群（子进程启动子进程）。

## 问题总结

    2月20号上线的平滑重启脚本实现了更新的无缝重启，结合 egg 的关闭钩子
```js
app.beforeClose(async() => {
    const server = app.server;
    // 在worker重启的时候，禁止新的请求访问
    server.close();
    // 访问请求超时
    await new Promise(resolve => setTimeout(resolve, 5000));
});
```
    上线后短时时间内没有发现问题，之后更新的代码也都开始无缝更新，重启状况良好

    2月21号发生磁盘报警，发现日志写入的级别限制没有生效，
    查看alinode监控发现系统指标都有记录，但是 qps 和进程存活没有记录，
    怀疑 ecs 的启动需要先声明 env 的环境。
    
    梳理了启动环境顺序后
    ecs -> child_process -> egg-bin -> egg启动 -> 加载config

    在子进程启动 egg 的时候，拿了默认的 env 环境， 而 config 的配置是后注入的，所以 config.prod.js 里的配置比 env 的配置要完加载

    更新 ecs 的启动脚本，添加 path 环境，本地测试接口正常
```js
env.HOME = HOME;
env.NODE_ENV = 'production';

// it makes env big but more robust
env.PATH = env.Path = [
    // for nodeinstall
    path.join(baseDir, 'node_modules/.bin'),
    // support `.node/bin`, due to npm5 will remove `node_modules/.bin`
    path.join(baseDir, '.node/bin'),
    // adjust env for win
    env.PATH || env.Path,
    // 加入全局的 PATH
].filter(x => !!x).join(path.delimiter);

env.ENABLE_NODE_LOG = 'YES';
env.NODE_LOG_DIR = env.NODE_LOG_DIR || path.join(logDir, 'alinode');
await mkdirp(env.NODE_LOG_DIR);
```

    更新脚本到 stage 服务器，启动后测试接口访问正常，并且 alinode 能够监控到完整的服务信息了
    此时以为启动脚本无问题，便直接将启动脚本更新到线上环境

    更新后只做了接口请求的排查，忽略了前端页面的检查，造成了一开始描述的问题
    暂时先将启动脚本切换egg 的默认启动脚本

```js
env.HOME = HOME;
env.NODE_ENV = 'production';

// it makes env big but more robust
env.PATH = env.Path = [
    // for nodeinstall
    path.join(baseDir, 'node_modules/.bin'),
    // support `.node/bin`, due to npm5 will remove `node_modules/.bin`
    path.join(baseDir, '.node/bin'),
    // adjust env for win
    env.PATH || env.Path,
    // 加入全局的 PATH
    process.env.PATH // 翻车在这里、
].filter(x => !!x).join(path.delimiter);

env.ENABLE_NODE_LOG = 'YES';
env.NODE_LOG_DIR = env.NODE_LOG_DIR || path.join(logDir, 'alinode');
await mkdirp(env.NODE_LOG_DIR);
```

    修复的 ecs 已经打包，复盘后经过大家商讨再另外计划上线